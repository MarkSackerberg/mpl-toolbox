name: Main

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CACHE: true

jobs:
  build_programs:
    name: Programs
    uses: ./.github/workflows/build-programs.yml
    secrets: inherit

  test_programs:
    name: Programs
    uses: ./.github/workflows/test-programs.yml
    secrets: inherit

  generate_clients:
    name: Generate clients
    runs-on: ubuntu-latest
    needs: [build_programs]
    permissions:
      contents: write
    steps:
      - name: Git checkout
        uses: actions/checkout@v3

      - name: DEBUG
        run: |
          echo "FOO=${{ vars.FOO }}"
          echo "SOLANA_VERSION=${{ vars.SOLANA_VERSION }}"

      - name: Install Node.js
        uses: ./.github/actions/install-node
        with:
          version: ${{ vars.NODE_VERSION }}
          cache: ${{ env.CACHE }}

      - name: Cache IDL generators
        if: env.CACHE == 'true'
        uses: actions/cache@v3
        with:
          path: ./.crates/
          key: ${{ runner.os }}-idl-generators-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-idl-generators

      - name: Generate IDLs and clients
        run: pnpm generate

      - name: Commit generated clients
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Update generated clients

  verify_js:
    name: JS client
    needs: [generate_clients]
    uses: ./.github/workflows/test-js.yml
    secrets: inherit
